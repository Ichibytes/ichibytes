#!/usr/bin/env node

/**
 * Script to generate TypeScript types from OpenAPI schema
 *
 * Usage:
 *   npm run generate:api-types
 *
 * This script fetches the OpenAPI JSON schema from the running API
 * and generates TypeScript types using openapi-typescript CLI.
 */

const fs = require("fs");
const path = require("path");
const https = require("https");
const http = require("http");
const { execSync } = require("child_process");

const API_URL = process.env.API_URL || "http://localhost:3000";
const OUTPUT_DIR = path.join(__dirname, "../libs/api-client/src/lib/generated");
const SCHEMA_FILE = path.join(OUTPUT_DIR, "openapi.json");
const TYPES_FILE = path.join(OUTPUT_DIR, "types.ts");

function fetchOpenApiSchema() {
  return new Promise((resolve, reject) => {
    const url = new URL(`${API_URL}/api/docs-json`);
    const client = url.protocol === "https:" ? https : http;

    console.log(`Fetching OpenAPI schema from ${url.toString()}...`);

    client
      .get(url.toString(), (res) => {
        let data = "";

        res.on("data", (chunk) => {
          data += chunk;
        });

        res.on("end", () => {
          if (res.statusCode !== 200) {
            reject(
              new Error(
                `Failed to fetch OpenAPI schema: ${res.statusCode} ${res.statusMessage}`
              )
            );
            return;
          }

          try {
            const schema = JSON.parse(data);
            resolve(schema);
          } catch (error) {
            reject(new Error(`Failed to parse OpenAPI schema: ${error}`));
          }
        });
      })
      .on("error", (error) => {
        const errorMessage = error.message || "Unknown error";
        const errorCode = error.code || "";

        if (
          errorCode === "ECONNREFUSED" ||
          errorCode === "ENOTFOUND" ||
          errorMessage.includes("ECONNREFUSED") ||
          errorMessage.includes("connect")
        ) {
          reject(
            new Error(
              `Failed to connect to API at ${API_URL}.\n` +
                `Make sure the API is running:\n` +
                `  npm run dev:api\n\n` +
                `Or set a different API URL:\n` +
                `  API_URL=http://localhost:3000 npm run generate:api-types`
            )
          );
        } else {
          reject(
            new Error(
              `Failed to fetch OpenAPI schema from ${API_URL}: ${errorMessage}`
            )
          );
        }
      });
  });
}

function generateTypeScriptTypes(schemaUrl) {
  console.log("Generating TypeScript types using openapi-typescript...");

  try {
    // Use openapi-typescript CLI via npx
    const command = `npx --yes openapi-typescript "${schemaUrl}" --output "${TYPES_FILE}"`;
    execSync(command, { stdio: "inherit" });

    // Read the generated file and add header
    let content = fs.readFileSync(TYPES_FILE, "utf8");
    const header = `// Auto-generated types from OpenAPI schema
// DO NOT EDIT THIS FILE MANUALLY
// Run 'npm run generate:api-types' to regenerate
// Generated using openapi-typescript: https://github.com/drwpow/openapi-typescript

`;

    // Only add header if it's not already there
    if (!content.includes("Auto-generated types from OpenAPI schema")) {
      content = header + content;
      fs.writeFileSync(TYPES_FILE, content);
    }

    return true;
  } catch (error) {
    throw new Error(`Failed to generate types: ${error.message}`);
  }
}

async function main() {
  try {
    // Create output directory if it doesn't exist
    if (!fs.existsSync(OUTPUT_DIR)) {
      fs.mkdirSync(OUTPUT_DIR, { recursive: true });
    }

    // Fetch OpenAPI schema
    const schema = await fetchOpenApiSchema();

    // Save raw schema JSON
    fs.writeFileSync(SCHEMA_FILE, JSON.stringify(schema, null, 2));
    console.log(`✓ Saved OpenAPI schema to ${SCHEMA_FILE}`);

    // Generate TypeScript types using openapi-typescript CLI
    const schemaUrl = `${API_URL}/api/docs-json`;
    await generateTypeScriptTypes(schemaUrl);

    console.log(`✓ Generated TypeScript types to ${TYPES_FILE}`);

    console.log("\n✓ Type generation complete!");
    console.log("\nThe generated types are available as:");
    console.log(
      "  import type { paths, components } from '@ichibytes/api-client/lib/generated/types';"
    );
  } catch (error) {
    console.error("\n✗ Error generating types:");
    console.error(error.message);
    console.error(
      "\nTip: Make sure the API server is running before generating types."
    );
    process.exit(1);
  }
}

main();
